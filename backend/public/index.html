<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GIS Fullstack Demo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body, html { height: 100%; margin: 0; }
    #map { width: 100%; height: 80vh; }
    .ol-popup { background:white; border:1px solid #333; padding:5px; position:absolute; z-index:1000; }
    .map-cursor-pointer { cursor: pointer !important; }
    #basemapBtns button.active { border: 2px solid #0a0; border-radius: 4px; }
    .action-btns button.active { border: 2px solid #000; border-radius: 4px; }
  </style>
</head>
<body>
<div class="container-fluid h-100 d-flex flex-column">
  <header class="bg-success text-white p-2 text-center fs-4">GIS Fullstack Demo</header>

  <div class="d-flex justify-content-between align-items-center p-2 bg-light">
    <!-- Basemap Buttons -->
    <div class="d-flex align-items-center" id="basemapBtns">
      <strong class="me-2">Basemap:</strong>
      <button class="btn btn-sm btn-success mx-1" id="osmBtn">OSM</button>
      <button class="btn btn-sm btn-primary mx-1" id="cartoBtn">Carto</button>
      <button class="btn btn-sm btn-primary mx-1" id="esriBtn">Esri</button>
    </div>

    <!-- WMS Layers -->
    <div class="d-flex flex-column align-items-center">
      <h6 class="mb-2">WMS Layers</h6>
      <div class="d-flex justify-content-between gap-3">
        <div>
          <input type="checkbox" id="statesLayer" checked> States
          <input type="range" id="statesOpacity" min="0" max="1" step="0.05" value="1">
        </div>
        <div>
          <input type="checkbox" id="citiesLayer" checked> Cities
          <input type="range" id="citiesOpacity" min="0" max="1" step="0.05" value="1">
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex align-items-center action-btns">
      <button class="btn btn-sm btn-success mx-1" id="allshowBtn">All Locations</button>
      <button class="btn btn-sm btn-success mx-1" id="addBtn">Add Place</button>
      <button class="btn btn-sm btn-warning mx-1" id="nearestBtn">Nearest</button>
      <button class="btn btn-sm btn-info mx-1" id="nearbyBtn">Nearby</button>
      <button class="btn btn-sm btn-dark mx-1" id="distanceBtn">Distance</button>
    </div>
  </div>

  <!-- Map -->
  <div id="map" class="flex-fill"></div>
</div>

<!-- Modals -->
<div class="modal" tabindex="-1" id="placeModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="placeModalTitle">Add Place</h5>
        <button type="button" class="btn-close" id="closeModalBtn"></button>
      </div>
      <div class="modal-body" id="placeModalBody"></div>
      <div class="modal-footer" id="placeModalFooter">
        <button class="btn btn-secondary" id="modalClose">Close</button>
        <button class="btn btn-primary" id="modalAction">Submit</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" tabindex="-1" id="distanceModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Distance Result</h5></div>
      <div class="modal-body" id="distanceResult"></div>
      <div class="modal-footer"><button class="btn btn-secondary" id="distanceClose">Close</button></div>
    </div>
  </div>
</div>

<div id="popup" class="ol-popup"></div>

<script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* -------------------- Map Layers -------------------- */
const osmLayer = new ol.layer.Tile({ source: new ol.source.OSM(), visible:true });
const cartoLayer = new ol.layer.Tile({ source: new ol.source.XYZ({ url:'https://{a-c}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png' }), visible:false });
const esriLayer = new ol.layer.Tile({ source: new ol.source.XYZ({ url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}' }), visible:false });

const vectorSource = new ol.source.Vector();
const vectorLayer = new ol.layer.Vector({ source: vectorSource });

const statesLayer = new ol.layer.Tile({ source:new ol.source.TileWMS({ url:'https://ahocevar.com/geoserver/wms', params:{LAYERS:'topp:states',TILED:true}, serverType:'geoserver'}), visible:true });
const citiesLayer = new ol.layer.Tile({ source:new ol.source.TileWMS({ url:'https://ahocevar.com/geoserver/wms', params:{LAYERS:'topp:tasmania_cities',TILED:true}, serverType:'geoserver'}), visible:true });

const map = new ol.Map({
  target:'map',
  layers:[osmLayer, cartoLayer, esriLayer, statesLayer, citiesLayer, vectorLayer],
  view: new ol.View({ center: ol.proj.fromLonLat([78.9629,20.5937]), zoom:5 })
});

/* -------------------- Popup -------------------- */
const popup = new ol.Overlay({ element: document.getElementById('popup'), positioning:'bottom-center', stopEvent:false });
map.addOverlay(popup);

/* -------------------- Modals -------------------- */
const placeModal = new bootstrap.Modal(document.getElementById('placeModal'));
const distanceModal = new bootstrap.Modal(document.getElementById('distanceModal'));
function clearModal(){ document.getElementById('placeModalBody').innerHTML=''; }

/* -------------------- Button Helpers -------------------- */
const basemapButtons = document.querySelectorAll('#basemapBtns button');
basemapButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    basemapButtons.forEach(b => { b.classList.remove('active','btn-success'); b.classList.add('btn-primary'); });
    btn.classList.add('active','btn-success'); btn.classList.remove('btn-primary');
  });
});
document.getElementById('osmBtn').classList.add('active','btn-success');

const actionButtons = document.querySelectorAll('.action-btns button');
actionButtons.forEach(btn => {
  btn.addEventListener('click', () => { actionButtons.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); });
});

/* -------------------- Show All Locations -------------------- */
document.getElementById('allshowBtn').addEventListener('click', async () => {
  vectorSource.clear();
  try {
    const res = await fetch('http://localhost:4000/api/places/all');
    if(!res.ok) throw new Error('Failed');
    const places = await res.json();
    places.forEach(p => {
      const [lng, lat] = p.location.coordinates;
      const feat = new ol.Feature({ geometry:new ol.geom.Point(ol.proj.fromLonLat([lng, lat])) });
      feat.setProperties({name:p.name, type:p.type, lat:lat, lng:lng});
      feat.setStyle(new ol.style.Style({ image:new ol.style.Icon({ src:'https://cdn-icons-png.flaticon.com/512/684/684908.png', scale:0.04 }) }));
      vectorSource.addFeature(feat);
    });
    map.getView().fit(vectorSource.getExtent(), { padding:[50,50,50,50], maxZoom:6 });
  } catch(e){ alert(e.message); }
});

/* -------------------- Add Place -------------------- */
function showAddPlaceModal(){
  clearModal();
  document.getElementById('placeModalTitle').innerText='Add Place';
  document.getElementById('placeModalBody').innerHTML=`
    <div class="mb-2"><label>Name</label><input class="form-control" id="placeName"></div>
    <div class="mb-2"><label>Type</label><input class="form-control" id="placeType"></div>
    <div class="mb-2"><label>Latitude</label><input class="form-control" id="placeLat"></div>
    <div class="mb-2"><label>Longitude</label><input class="form-control" id="placeLng"></div>
    <button class="btn btn-secondary btn-sm" id="mapClickBtn">Pick from Map</button>
    <small id="mapClickInfo" class="text-muted d-block mt-1" style="display:none;">Click on map to select coordinates...</small>
  `;
  document.getElementById('modalAction').innerText='Add Place';
  placeModal.show();

  document.getElementById('mapClickBtn').onclick = ()=>{
    mapClickMode='add';
    document.getElementById('mapClickInfo').style.display='block';
    document.getElementById('map').classList.add('map-cursor-pointer');
    placeModal.hide();
  }

  document.getElementById('modalAction').onclick=async ()=>{
    const name=document.getElementById('placeName').value;
    const type=document.getElementById('placeType').value;
    const lat=parseFloat(document.getElementById('placeLat').value);
    const lng=parseFloat(document.getElementById('placeLng').value);
    if(!name||!lat||!lng){ alert('All fields required'); return; }
    const res=await fetch('http://localhost:4000/api/places',{
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name,type,lat,lng})
    });
    if(!res.ok){ alert('Failed to add place'); return; }
    const feat=new ol.Feature({ geometry:new ol.geom.Point(ol.proj.fromLonLat([lng,lat])) });
    feat.setProperties({name:type, type:type, lat:lat, lng:lng});
    feat.setStyle(new ol.style.Style({ image:new ol.style.Icon({ src:'https://cdn-icons-png.flaticon.com/512/684/684908.png', scale:0.04 }) }));
    vectorSource.addFeature(feat);
    clearModal(); placeModal.hide();
  }
}

/* -------------------- Nearest & Nearby -------------------- */
async function fetchAndShow(url){
  vectorSource.clear();
  const res = await fetch(url); const data=await res.json();
  if(Array.isArray(data)){
    data.forEach(p=>{
      const [lng,lat] = p.location.coordinates;
      const feat = new ol.Feature({ geometry:new ol.geom.Point(ol.proj.fromLonLat([lng,lat])) });
      feat.setProperties({name:p.name, type:p.type, lat:lat, lng:lng});
      feat.setStyle(new ol.style.Style({ image:new ol.style.Icon({ src:'https://cdn-icons-png.flaticon.com/512/684/684908.png', scale:0.04 }) }));
      vectorSource.addFeature(feat);
    });
  } else if(data.location){
    const [lng,lat] = data.location.coordinates;
    const feat = new ol.Feature({ geometry:new ol.geom.Point(ol.proj.fromLonLat([lng,lat])) });
    feat.setProperties({name:data.location.name, type:data.location.type, lat:lat, lng:lng});
    feat.setStyle(new ol.style.Style({ image:new ol.style.Icon({ src:'https://cdn-icons-png.flaticon.com/512/684/684908.png', scale:0.04 }) }));
    vectorSource.addFeature(feat);
  }
}

function showNearestModal(){
  clearModal();
  vectorSource.clear(); // clear existing markers
  document.getElementById('placeModalTitle').innerText='Nearest Place';
  document.getElementById('placeModalBody').innerHTML=`
    <div class="mb-2"><label>Latitude</label><input class="form-control" id="nearestLat"></div>
    <div class="mb-2"><label>Longitude</label><input class="form-control" id="nearestLng"></div>
    <button class="btn btn-secondary btn-sm" id="nearestMapClickBtn">Pick from Map</button>
    <small id="nearestMapClickInfo" class="text-muted d-block mt-1" style="display:none;">Click on map to select coordinates...</small>
  `;
  document.getElementById('modalAction').innerText='Find Nearest';
  placeModal.show();

  document.getElementById('nearestMapClickBtn').onclick = ()=>{
    mapClickMode='nearest';
    document.getElementById('nearestMapClickInfo').style.display='block';
    document.getElementById('map').classList.add('map-cursor-pointer');
    placeModal.hide();
  }

  document.getElementById('modalAction').onclick=async ()=>{
    const lat=parseFloat(document.getElementById('nearestLat').value);
    const lng=parseFloat(document.getElementById('nearestLng').value);
    if(!lat||!lng){ alert('All fields required'); return; }

    const res = await fetch(`http://localhost:4000/api/places/nearest?lat=${lat}&lng=${lng}`);
    const data = await res.json();

    if(data && data.location){
      const [lon, plat] = data.location.coordinates;
      const feat = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, plat]))
      });
      // **Set properties for popup**
      feat.setProperties({
        name: data.name || "Nearest Place",
        type: data.type || "Type unknown",
        lat: plat,
        lng: lon
      });
      feat.setStyle(new ol.style.Style({
        image:new ol.style.Icon({ src:'https://cdn-icons-png.flaticon.com/512/684/684908.png', scale:0.04 })
      }));
      vectorSource.addFeature(feat);
      map.getView().setCenter(ol.proj.fromLonLat([lon, plat]));
      map.getView().setZoom(8);
    } else { alert('No nearest place found'); }

    clearModal();
    placeModal.hide();
  }
}

function showNearbyModal(){
  clearModal();
  document.getElementById('placeModalTitle').innerText='Nearby Places';
  document.getElementById('placeModalBody').innerHTML=`
    <div class="mb-2"><label>Latitude</label><input class="form-control" id="nearbyLat"></div>
    <div class="mb-2"><label>Longitude</label><input class="form-control" id="nearbyLng"></div>
    <div class="mb-2"><label>Radius (m)</label><input class="form-control" id="nearbyRadius" value="5000"></div>
    <button class="btn btn-secondary btn-sm" id="nearbyMapClickBtn">Pick from Map</button>
    <small id="nearbyMapClickInfo" class="text-muted d-block mt-1" style="display:none;">Click on map to select coordinates...</small>
  `;
  document.getElementById('modalAction').innerText='Find Nearby';
  placeModal.show();

  document.getElementById('nearbyMapClickBtn').onclick = ()=>{
    mapClickMode='nearby';
    document.getElementById('nearbyMapClickInfo').style.display='block';
    document.getElementById('map').classList.add('map-cursor-pointer');
    placeModal.hide();
  }

  document.getElementById('modalAction').onclick=async ()=>{
    const lat=parseFloat(document.getElementById('nearbyLat').value);
    const lng=parseFloat(document.getElementById('nearbyLng').value);
    const radius=parseFloat(document.getElementById('nearbyRadius').value);
    if(!lat||!lng||!radius){ alert('All fields required'); return; }
    await fetchAndShow(`http://localhost:4000/api/places/nearby?lat=${lat}&lng=${lng}&radius=${radius}`);
    clearModal(); placeModal.hide();
  }
}

/* -------------------- Distance -------------------- */
let mapClickMode = null;
let distancePoints = [], distanceMarkers = [], distanceLine = null;

function activateDistanceMode(){
  vectorSource.clear(); distancePoints=[]; distanceMarkers=[]; if(distanceLine) vectorSource.removeFeature(distanceLine); distanceLine=null;
  mapClickMode='distance'; document.getElementById('map').classList.add('map-cursor-pointer');
  alert('Click two points on the map to measure distance');
}

/* -------------------- Map Click -------------------- */
map.on('singleclick', async evt=>{
  const coord=ol.proj.toLonLat(evt.coordinate);

  if(mapClickMode==='add'){
    document.getElementById('placeLat').value=coord[1]; document.getElementById('placeLng').value=coord[0]; placeModal.show();
    mapClickMode=null; document.getElementById('map').classList.remove('map-cursor-pointer'); return;
  }
  if(mapClickMode==='nearest'){
    document.getElementById('nearestLat').value=coord[1]; document.getElementById('nearestLng').value=coord[0]; placeModal.show();
    mapClickMode=null; document.getElementById('map').classList.remove('map-cursor-pointer'); return;
  }
  if(mapClickMode==='nearby'){
    document.getElementById('nearbyLat').value=coord[1]; document.getElementById('nearbyLng').value=coord[0]; placeModal.show();
    mapClickMode=null; document.getElementById('map').classList.remove('map-cursor-pointer'); return;
  }

  if(mapClickMode==='distance'){
    distancePoints.push(coord);
    const marker=new ol.Feature({ geometry:new ol.geom.Point(ol.proj.fromLonLat(coord)) });
    marker.setStyle(new ol.style.Style({ image:new ol.style.Icon({ src:'https://cdn-icons-png.flaticon.com/512/684/684908.png', scale:0.04 }) }));
    vectorSource.addFeature(marker); distanceMarkers.push(marker);

    if(distancePoints.length===2){
      distanceLine=new ol.Feature({ geometry:new ol.geom.LineString(distancePoints.map(c=>ol.proj.fromLonLat(c))) });
      distanceLine.setStyle(new ol.style.Style({ stroke:new ol.style.Stroke({ color:'#ff0', width:3 }) }));
      vectorSource.addFeature(distanceLine);

      const [c1,c2]=distancePoints;
      const res=await fetch(`http://localhost:4000/api/places/distance?lat1=${c1[1]}&lng1=${c1[0]}&lat2=${c2[1]}&lng2=${c2[0]}`);
      const data=await res.json();
      const distanceKm=(data.distance_meters/1000).toFixed(2);
      document.getElementById('distanceResult').innerText=`Distance between points: ${distanceKm} km`;
      distanceModal.show();

      mapClickMode=null; distancePoints=[]; document.getElementById('map').classList.remove('map-cursor-pointer');
    }
  }
});

/* -------------------- Hover Popup -------------------- */
map.on('pointermove', evt=>{
  const feat = map.forEachFeatureAtPixel(evt.pixel, f=>f);
  if(feat){
    const coord = feat.getGeometry().getCoordinates();
    const props = feat.getProperties();
    popup.setPosition(coord);
    document.getElementById('popup').innerHTML=`<b>${props.name || ''}</b><br>${props.type || ''}<br>Lat: ${props.lat.toFixed(5)}, Lng: ${props.lng.toFixed(5)}`;
  } else { popup.setPosition(undefined); }
});

/* -------------------- Modal Close -------------------- */
document.getElementById('closeModalBtn').onclick = document.getElementById('modalClose').onclick = ()=>{ clearModal(); placeModal.hide(); mapClickMode=null; document.getElementById('map').classList.remove('map-cursor-pointer'); }
document.getElementById('distanceClose').onclick = ()=>{ distanceModal.hide(); mapClickMode=null; document.getElementById('map').classList.remove('map-cursor-pointer'); }

/* -------------------- Event Bindings -------------------- */
document.getElementById('addBtn').onclick=showAddPlaceModal;
document.getElementById('nearestBtn').onclick=showNearestModal;
document.getElementById('nearbyBtn').onclick=showNearbyModal;
document.getElementById('distanceBtn').onclick=activateDistanceMode;

// WMS Layers
document.getElementById('statesLayer').onchange = e => statesLayer.setVisible(e.target.checked);
document.getElementById('citiesLayer').onchange = e => citiesLayer.setVisible(e.target.checked);
document.getElementById('statesOpacity').oninput = e => statesLayer.setOpacity(e.target.value);
document.getElementById('citiesOpacity').oninput = e => citiesLayer.setOpacity(e.target.value);

// Basemap Switching
document.getElementById('osmBtn').onclick = ()=>{ osmLayer.setVisible(true); cartoLayer.setVisible(false); esriLayer.setVisible(false); }
document.getElementById('cartoBtn').onclick = ()=>{ osmLayer.setVisible(false); cartoLayer.setVisible(true); esriLayer.setVisible(false); }
document.getElementById('esriBtn').onclick = ()=>{ osmLayer.setVisible(false); cartoLayer.setVisible(false); esriLayer.setVisible(true); }

</script>
</body>
</html>